"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _fsExtra = require("fs-extra");

var _fsExtra2 = _interopRequireDefault(_fsExtra);

var _path = require("path");

var _path2 = _interopRequireDefault(_path);

var _tools = require("../../../tools");

var _utils = require("../../../utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function parse(context) {
  const grantsFolder = _path2.default.join(context.filePath, _tools.constants.CLIENTS_GRANTS_DIRECTORY);

  if (!(0, _utils.existsMustBeDir)(grantsFolder)) return {
    clientGrants: undefined
  };
  const foundFiles = (0, _utils.getFiles)(grantsFolder, ['.json']);
  const clientGrants = foundFiles.map(f => (0, _utils.loadJSON)(f, context.mappings)).filter(p => Object.keys(p).length > 0);
  return {
    clientGrants
  };
}

async function dump(context) {
  const {
    clientGrants
  } = context.assets;
  if (!clientGrants) return;

  const grantsFolder = _path2.default.join(context.filePath, _tools.constants.CLIENTS_GRANTS_DIRECTORY);

  _fsExtra2.default.ensureDirSync(grantsFolder);

  clientGrants.forEach(grant => {
    const dumpGrant = { ...grant
    };
    dumpGrant.client_id = (0, _utils.convertClientIdToName)(dumpGrant.client_id, context.assets.clientsOrig);
    const name = (0, _utils.sanitize)(`${dumpGrant.client_id} (${dumpGrant.audience})`);

    const grantFile = _path2.default.join(grantsFolder, `${name}.json`);

    (0, _utils.dumpJSON)(grantFile, dumpGrant);
  });
}

exports.default = {
  parse,
  dump
};