"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _fsExtra = require("fs-extra");

var _fsExtra2 = _interopRequireDefault(_fsExtra);

var _path = require("path");

var _path2 = _interopRequireDefault(_path);

var _tools = require("../../../tools");

var _logger = require("../../../logger");

var _logger2 = _interopRequireDefault(_logger);

var _utils = require("../../../utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function parse(context) {
  const emailsFolder = _path2.default.join(context.filePath, _tools.constants.EMAIL_TEMPLATES_DIRECTORY);

  if (!(0, _utils.existsMustBeDir)(emailsFolder)) return {
    emailTemplates: undefined
  };
  const files = (0, _utils.getFiles)(emailsFolder, ['.json', '.html']).filter(f => _path2.default.basename(f) !== 'provider.json');
  const sorted = {};
  files.forEach(file => {
    const {
      ext,
      name
    } = _path2.default.parse(file);

    if (!sorted[name]) sorted[name] = {};
    if (ext === '.json') sorted[name].meta = file;
    if (ext === '.html') sorted[name].html = file;
  });
  const emailTemplates = [];
  Object.values(sorted).forEach(data => {
    if (!data.meta) {
      _logger2.default.warn(`Skipping email template file ${data.html} as missing the corresponding '.json' file`);
    } else if (!data.html) {
      _logger2.default.warn(`Skipping email template file ${data.meta} as missing corresponding '.html' file`);
    } else {
      emailTemplates.push({ ...(0, _utils.loadJSON)(data.meta, context.mappings),
        body: (0, _tools.loadFile)(data.html, context.mappings)
      });
    }
  });
  return {
    emailTemplates
  };
}

async function dump(context) {
  const emailTemplates = [...(context.assets.emailTemplates || [])];
  if (!emailTemplates) return;

  const templatesFolder = _path2.default.join(context.filePath, _tools.constants.EMAIL_TEMPLATES_DIRECTORY);

  _fsExtra2.default.ensureDirSync(templatesFolder);

  emailTemplates.forEach(template => {
    const templateHtml = _path2.default.join(templatesFolder, `${template.template}.html`);

    _logger2.default.info(`Writing ${templateHtml}`);

    _fsExtra2.default.writeFileSync(templateHtml, template.body);

    const templateFile = _path2.default.join(templatesFolder, `${template.template}.json`);

    (0, _utils.dumpJSON)(templateFile, { ...template,
      body: `./${template.template}.html`
    });
  });
}

exports.default = {
  parse,
  dump
};