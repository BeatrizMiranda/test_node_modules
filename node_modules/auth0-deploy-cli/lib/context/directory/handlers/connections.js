"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _fsExtra = require("fs-extra");

var _fsExtra2 = _interopRequireDefault(_fsExtra);

var _path = require("path");

var _path2 = _interopRequireDefault(_path);

var _tools = require("../../../tools");

var _logger = require("../../../logger");

var _logger2 = _interopRequireDefault(_logger);

var _utils = require("../../../utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function parse(context) {
  const connectionDirectory = context.config.AUTH0_CONNECTIONS_DIRECTORY || _tools.constants.CONNECTIONS_DIRECTORY;

  const connectionsFolder = _path2.default.join(context.filePath, connectionDirectory);

  if (!(0, _utils.existsMustBeDir)(connectionsFolder)) return {
    connections: undefined
  };
  const foundFiles = (0, _utils.getFiles)(connectionsFolder, ['.json']);
  const connections = foundFiles.map(f => {
    const connection = (0, _utils.loadJSON)(f, context.mappings);

    if (connection.strategy === 'email') {
      (0, _utils.ensureProp)(connection, 'options.email.body');

      const htmlFileName = _path2.default.join(connectionsFolder, connection.options.email.body);

      if ((0, _utils.isFile)(htmlFileName)) {
        connection.options.email.body = (0, _tools.loadFile)(htmlFileName, context.mappings);
      }
    }

    return connection;
  }).filter(p => Object.keys(p).length > 0);
  return {
    connections
  };
}

async function dump(context) {
  const {
    connections
  } = context.assets;
  if (!connections) return;

  const connectionsFolder = _path2.default.join(context.filePath, _tools.constants.CONNECTIONS_DIRECTORY);

  _fsExtra2.default.ensureDirSync(connectionsFolder);

  connections.forEach(connection => {
    const dumpedConnection = { ...connection,
      ...(connection.enabled_clients && {
        enabled_clients: (0, _utils.mapClientID2NameSorted)(connection.enabled_clients, context.assets.clientsOrig)
      })
    };
    const connectionName = (0, _utils.sanitize)(dumpedConnection.name);

    if (dumpedConnection.strategy === 'email') {
      (0, _utils.ensureProp)(dumpedConnection, 'options.email.body');
      const html = dumpedConnection.options.email.body;

      const emailConnectionHtml = _path2.default.join(connectionsFolder, `${connectionName}.html`);

      _logger2.default.info(`Writing ${emailConnectionHtml}`);

      _fsExtra2.default.writeFileSync(emailConnectionHtml, html);

      dumpedConnection.options.email.body = `./${connectionName}.html`;
    }

    const connectionFile = _path2.default.join(connectionsFolder, `${connectionName}.json`);

    (0, _utils.dumpJSON)(connectionFile, dumpedConnection);
  });
}

exports.default = {
  parse,
  dump
};